<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Chi Tiết Sự Kiện</title>
    <meta name="description" content="">
    <meta name="keywords" content="">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

    <!-- Main CSS File -->
    <link href="assets/css/main.css" rel="stylesheet">
    <link href="assets/css/event_detail.css" rel="stylesheet">
</head>

<body>
    <div id="header"></div>

    <header class="py-4 text-center bg-light">
        <h1 id="eventName" class="fw-bold">Đang tải...</h1>
        <p id="eventDescription">Vui lòng chờ...</p>
    </header>

    <main class="container mt-4">
        <div class="row">
            <div class="col-lg-8">
                <div id="eventCarousel" class="carousel slide event-carousel" data-bs-ride="carousel">
                    <div class="carousel-inner" id="carouselImages">
                        <div class="carousel-item active"></div>
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#eventCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#eventCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                </div>
            </div>

            <div class="col-lg-4">
                <h2>Lịch Trình</h2>
                <ul class="list-group" id="eventTimeline">
                    <li class="list-group-item">Đang tải...</li>
                </ul>
            </div>
        </div>

        <section class="mt-5">
            <div class="table-responsive mt-4">
                <h3>THIẾT BỊ</h3>
                <table class="table table-bordered text-center">
                    <thead class="table-light">
                        <tr>
                            <th>Hình ảnh</th>
                            <th>Tên Thiết Bị</th>
                            <th>Mô Tả</th>
                            <th>Nhà Cung Cấp</th>
                            <th>Số Lượng</th>
                            <th>Đơn Giá</th>
                            <th>Thành Tiền</th>
                        </tr>
                    </thead>
                    <tbody id="equipmentList">
                        <tr>
                            <td colspan="7">Đang tải...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="table-responsive mt-4">
                <h3>DỊCH VỤ</h3>
                <table class="table table-bordered text-center">
                    <thead class="table-light">
                        <tr>
                            <th>Hình ảnh</th>
                            <th>Tên Dịch Vụ</th>
                            <th>Mô Tả</th>
                            <th>Nhà Cung Cấp</th>
                            <th>Số Lượng</th>
                            <th>Đơn Giá</th>
                            <th>Thành Tiền</th>
                        </tr>
                    </thead>
                    <tbody id="staffList">
                        <tr>
                            <td colspan="7">Đang tải...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="table-responsive mt-4">
                <h3>ĐỊA ĐIỂM</h3>
                <table class="table table-bordered text-center">
                    <thead class="table-light">
                        <tr>
                            <th>Hình ảnh</th>
                            <th>Tên Địa Điểm</th>
                            <th>Nhà Cung Cấp</th>
                            <th>Từ Ngày</th>
                            <th>Đến Ngày</th>
                            <th>Số Ngày Thuê</th>
                            <th>Đơn Giá (VND/ngày)</th>
                            <th>Thành Tiền (VND)</th>
                        </tr>
                    </thead>
                    <tbody id="locationList">
                        <tr>
                            <td colspan="8">Đang tải...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="text-end mt-3">
                <h4 class="fw-bold">Tổng tiền: <span id="totalPrice">0</span> VND</h4>
                <div class="alert d-flex flex-column flex-md-row align-items-md-center justify-content-between mt-3 p-3"
                    style="background-color: #E9F5DB; border: 1px solid #D4E2C3;">
                    <div class="text-container">
                        <i class="bi bi-info-circle"></i>
                        <span class="text">
                            Bạn có nhu cầu tổ chức sự kiện này?<br class="d-md-none">
                            Nhấn vào nút bên cạnh để đăng ký ngay nhé!
                        </span>
                    </div>
                    <div>
                        <button type="button" class="btn fw-bold text-white px-4 py-2" style="background-color: #718355;">
                            Đăng ký ngay
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer id="footer"></footer>

    <!-- Scroll Top -->
    <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center">
        <i class="bi bi-arrow-up-short"></i>
    </a>

    <!-- Preloader -->
    <div id="preloader"></div>

    <!-- Vendor JS Files -->
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/aos/aos.js"></script>
    <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
    <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>

    <!-- Main JS File -->
    <script src="assets/js/main.js"></script>
    <script src="assets/js/event-detail.js"></script>
    <script src="assets/js/header.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get("id");

            if (!eventId) {
                document.getElementById("eventName").textContent = "Không tìm thấy sự kiện!";
                document.getElementById("eventDescription").textContent = "Vui lòng quay lại trang danh sách.";
                return;
            }

            try {
                const response = await fetch("assets/data/dv.json");
                const data = await response.json();
                const event = data.event.find(e => e.id == eventId);

                if (!event) {
                    document.getElementById("eventName").textContent = "Sự kiện không tồn tại!";
                    document.getElementById("eventDescription").textContent = "Vui lòng kiểm tra lại.";
                    return;
                }

                // Cập nhật tiêu đề và mô tả
                document.getElementById("eventName").textContent = event.name;
                document.getElementById("eventDescription").textContent = event.description || "Không có mô tả";

                // Cập nhật carousel hình ảnh
                const carouselImages = document.getElementById("carouselImages");
                carouselImages.innerHTML = "";
                const images = event.images || [event.image];
                images.forEach((img, index) => {
                    const activeClass = index === 0 ? "active" : "";
                    carouselImages.innerHTML += `
                        <div class="carousel-item ${activeClass}">
                            <img src="${img}" class="d-block w-100" alt="${event.name}">
                        </div>
                    `;
                });

                // Cập nhật lịch trình
                const timeline = document.getElementById("eventTimeline");
                timeline.innerHTML = "";
                const timelineData = event.timeline || ["Không có thông tin lịch trình"];
                timelineData.forEach(item => {
                    timeline.innerHTML += `<li class="list-group-item">${item}</li>`;
                });

                // Cập nhật danh sách thiết bị
                const equipmentList = document.getElementById("equipmentList");
                equipmentList.innerHTML = "";
                const equipment = event.equipment || [];
                if (equipment.length === 0) {
                    equipmentList.innerHTML = "<tr><td colspan='7'>Không có thiết bị</td></tr>";
                } else {
                    equipment.forEach(item => {
                        equipmentList.innerHTML += `
                            <tr>
                                <td><img src="${item.image}" alt="${item.name}" style="max-width: 50px;"></td>
                                <td>${item.name}</td>
                                <td>${item.description || "Không có mô tả"}</td>
                                <td>${item.supplier || "Không xác định"}</td>
                                <td>${item.quantity}</td>
                                <td>${item.unitPrice.toLocaleString()}</td>
                                <td>${(item.quantity * item.unitPrice).toLocaleString()}</td>
                            </tr>
                        `;
                    });
                }

                // Cập nhật danh sách dịch vụ
                const staffList = document.getElementById("staffList");
                staffList.innerHTML = "";
                const staff = event.staff || [];
                if (staff.length === 0) {
                    staffList.innerHTML = "<tr><td colspan='7'>Không có dịch vụ</td></tr>";
                } else {
                    staff.forEach(item => {
                        staffList.innerHTML += `
                            <tr>
                                <td><img src="${item.image}" alt="${item.name}" style="max-width: 50px;"></td>
                                <td>${item.name}</td>
                                <td>${item.description || "Không có mô tả"}</td>
                                <td>${item.supplier || "Không xác định"}</td>
                                <td>${item.quantity}</td>
                                <td>${item.unitPrice.toLocaleString()}</td>
                                <td>${(item.quantity * item.unitPrice).toLocaleString()}</td>
                            </tr>
                        `;
                    });
                }

                // Cập nhật danh sách địa điểm
                const locationList = document.getElementById("locationList");
                locationList.innerHTML = "";
                const locations = event.locations || [];
                if (locations.length === 0) {
                    locationList.innerHTML = "<tr><td colspan='8'>Không có địa điểm</td></tr>";
                } else {
                    locations.forEach(item => {
                        const days = Math.ceil((new Date(item.toDate) - new Date(item.fromDate)) / (1000 * 60 * 60 * 24));
                        locationList.innerHTML += `
                            <tr>
                                <td><img src="${item.image}" alt="${item.name}" style="max-width: 50px;"></td>
                                <td>${item.name}</td>
                                <td>${item.supplier || "Không xác định"}</td>
                                <td>${item.fromDate}</td>
                                <td>${item.toDate}</td>
                                <td>${days}</td>
                                <td>${item.unitPrice.toLocaleString()}</td>
                                <td>${(days * item.unitPrice).toLocaleString()}</td>
                            </tr>
                        `;
                    });
                }

                // Tính và cập nhật tổng tiền
                const totalEquipment = equipment.reduce((sum, item) => sum + item.quantity * item.unitPrice, 0);
                const totalStaff = staff.reduce((sum, item) => sum + item.quantity * item.unitPrice, 0);
                const totalLocation = locations.reduce((sum, item) => {
                    const days = Math.ceil((new Date(item.toDate) - new Date(item.fromDate)) / (1000 * 60 * 60 * 24));
                    return sum + days * item.unitPrice;
                }, 0);
                const totalPrice = totalEquipment + totalStaff + totalLocation;
                document.getElementById("totalPrice").textContent = totalPrice.toLocaleString();

                // Thêm sự kiện cho nút "Đăng ký ngay"
                document.querySelector(".btn").addEventListener("click", function () {
                    const iframeModal = new bootstrap.Modal(document.createElement("div"));
                    iframeModal._element.innerHTML = `
                        <div class="modal fade" id="iframeModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-xl">
                                <div class="modal-content">
                                    <iframe src="contract.html" style="width: 100%; height: 600px; border: none;"></iframe>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(iframeModal._element);
                    iframeModal.show();

                    window.addEventListener("message", function closeModal(event) {
                        if (event.data === "closeIframe") {
                            iframeModal.hide();
                            window.removeEventListener("message", closeModal);
                        }
                    });
                });
            } catch (error) {
                console.error("Lỗi khi tải dữ liệu:", error);
                document.getElementById("eventName").textContent = "Lỗi tải dữ liệu!";
                document.getElementById("eventDescription").textContent = "Vui lòng thử lại sau.";
            }
        });
    </script>
</body>
</html>
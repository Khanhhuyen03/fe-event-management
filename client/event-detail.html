<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Chi Tiết Sự Kiện</title>
    <meta name="description" content="">
    <meta name="keywords" content="">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

    <!-- Main CSS File -->
    <link href="assets/css/main.css" rel="stylesheet">
    <link href="assets/css/event_detail.css" rel="stylesheet">
</head>

<body>
    <div id="header"></div>

    <header class="py-4 text-center bg-light">
        <h1 id="eventName" class="fw-bold">Đang tải...</h1>
        <p id="eventDescription">Vui lòng chờ...</p>
    </header>

    <main class="container mt-4">
        <div class="row">
            <div class="col-lg-8">
                <div id="eventCarousel" class="carousel slide event-carousel" data-bs-ride="carousel">
                    <div class="carousel-inner" id="carouselImages">
                        <div class="carousel-item active"></div>
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#eventCarousel"
                        data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#eventCarousel"
                        data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                </div>
            </div>

            <div class="col-lg-4">
                <h2>Lịch Trình</h2>
                <ul class="list-group" id="eventTimeline">
                    <li class="list-group-item">Đang tải...</li>
                </ul>
            </div>
        </div>

        <section class="mt-5">
            <div class="table-responsive mt-4">
                <h3>THIẾT BỊ</h3>
                <table class="table table-bordered text-center">
                    <thead class="table-light">
                        <tr>
                            <th>Hình ảnh</th>
                            <th>Tên Thiết Bị</th>
                            <th>Mô Tả</th>
                            <th>Nhà Cung Cấp</th>
                            <th>Số Lượng</th>
                            <th>Đơn Giá</th>
                            <th>Thành Tiền</th>
                        </tr>
                    </thead>
                    <tbody id="equipmentList">
                        <tr>
                            <td colspan="7">Đang tải...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="table-responsive mt-4">
                <h3>DỊCH VỤ</h3>
                <table class="table table-bordered text-center">
                    <thead class="table-light">
                        <tr>
                            <th>Hình ảnh</th>
                            <th>Tên Dịch Vụ</th>
                            <th>Mô Tả</th>
                            <th>Nhà Cung Cấp</th>
                            <th>Số Lượng</th>
                            <th>Đơn Giá</th>
                            <th>Thành Tiền</th>
                        </tr>
                    </thead>
                    <tbody id="staffList">
                        <tr>
                            <td colspan="7">Đang tải...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="table-responsive mt-4">
                <h3>ĐỊA ĐIỂM</h3>
                <table class="table table-bordered text-center">
                    <thead class="table-light">
                        <tr>
                            <th>Hình ảnh</th>
                            <th>Tên Địa Điểm</th>
                            <th>Nhà Cung Cấp</th>
                            <th>Từ Ngày</th>
                            <th>Đến Ngày</th>
                            <th>Số Ngày Thuê</th>
                            <th>Đơn Giá (VND/ngày)</th>
                            <th>Thành Tiền (VND)</th>
                        </tr>
                    </thead>
                    <tbody id="locationList">
                        <tr>
                            <td colspan="8">Đang tải...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="text-end mt-3">
                <div class="alert d-flex flex-column flex-md-row align-items-md-center justify-content-between mt-3 p-3"
                    style="background-color: #E9F5DB; border: 1px solid #D4E2C3;">
                    <div class="text-container">
                        <i class="bi bi-info-circle"></i>
                        <span class="text">
                            Bạn có nhu cầu tổ chức sự kiện này?<br class="d-md-none">
                            Nhấn vào nút bên cạnh để đăng ký ngay nhé!
                        </span>
                    </div>
                    <div>
                        <button type="button" class="btn fw-bold text-white px-4 py-2" id="registerBtn"
                            style="background-color: #718355;" onclick="checkLoginAndOpenContract()">
                            Đăng ký ngay
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="footer"></div>

    <!-- Modal chứa iframe -->
    <div class="modal fade" id="iframeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <iframe id="contractIframe" style="width: 100%; height: 600px; border: none;"></iframe>
            </div>
        </div>
    </div>

    <!-- Scroll Top -->
    <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center">
        <i class="bi bi-arrow-up-short"></i>
    </a>

    <!-- Preloader -->
    <div id="preloader"></div>

    <!-- Vendor JS Files -->
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/aos/aos.js"></script>
    <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
    <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>

    <!-- Main JS File -->
    <script src="assets/js/main.js"></script>
    <script src="assets/js/event-detail.js"></script>
    <script src="assets/js/header.js"></script>

    <script>
        let selectedEvent; // Biến toàn cục để lưu trữ dữ liệu sự kiện
        let suppliers = []; // Biến lưu danh sách nhà cung cấp

        // Hàm định dạng ngày thành dd/mm/yyyy
        function formatDateToDDMMYYYY(dateStr) {
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Hàm lấy tên nhà cung cấp từ supplier_id
        function getSupplierName(supplierId) {
            const supplier = suppliers.find(s => s.id === supplierId);
            return supplier ? `${supplier.first_name} ${supplier.last_name}` : "Không xác định";
        }

        document.addEventListener("DOMContentLoaded", async function () {
            const preloader = document.getElementById("preloader");
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get("id");

            if (!eventId) {
                document.getElementById("eventName").textContent = "Không tìm thấy sự kiện!";
                document.getElementById("eventDescription").textContent = "Vui lòng quay lại trang danh sách.";
                preloader.style.display = "none";
                return;
            }

            try {
                // Gọi API nhà cung cấp
                const suppliersResponse = await fetch("https://api.myevent.com/users?role=supplier", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${localStorage.getItem("token") || ""}`
                    }
                });
                if (!suppliersResponse.ok) {
                    throw new Error(`Lỗi khi lấy danh sách nhà cung cấp: ${suppliersResponse.statusText}`);
                }
                suppliers = await suppliersResponse.json();

                // Gọi API chi tiết sự kiện
                const eventResponse = await fetch(`https://api.myevent.com/events/${eventId}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${localStorage.getItem("token") || ""}`
                    }
                });
                if (!eventResponse.ok) {
                    throw new Error(`Lỗi khi lấy dữ liệu sự kiện: ${eventResponse.statusText}`);
                }
                const event = await eventResponse.json();

                if (!event) {
                    document.getElementById("eventName").textContent = "Sự kiện không tồn tại!";
                    document.getElementById("eventDescription").textContent = "Vui lòng kiểm tra lại.";
                    preloader.style.display = "none";
                    return;
                }

                selectedEvent = event; // Lưu dữ liệu sự kiện vào biến toàn cục

                // Cập nhật tiêu đề và mô tả
                document.getElementById("eventName").textContent = event.name;
                document.getElementById("eventDescription").textContent = event.description || "Không có mô tả";

                // Cập nhật carousel hình ảnh
                const carouselImages = document.getElementById("carouselImages");
                carouselImages.innerHTML = "";
                const images = event.images || [event.image] || ["./assets/img/placeholder.jpg"];
                images.forEach((img, index) => {
                    const activeClass = index === 0 ? "active" : "";
                    carouselImages.innerHTML += `
                        <div class="carousel-item ${activeClass}">
                            <img src="${img}" class="d-block w-100" alt="${event.name}">
                        </div>
                    `;
                });

                // Cập nhật lịch trình
                const timeline = document.getElementById("eventTimeline");
                timeline.innerHTML = "";
                const timelineData = event.timeline || ["Không có thông tin lịch trình"];
                timelineData.forEach(item => {
                    timeline.innerHTML += `<li class="list-group-item">${item}</li>`;
                });

                // Cập nhật danh sách thiết bị
                const equipmentList = document.getElementById("equipmentList");
                equipmentList.innerHTML = "";
                const devices = event.device || [];
                if (devices.length === 0) {
                    equipmentList.innerHTML = "<tr><td colspan='7'>Không có thiết bị</td></tr>";
                } else {
                    devices.forEach(item => {
                        equipmentList.innerHTML += `
                            <tr>
                                <td><img src="${item.image || './assets/img/placeholder.jpg'}" alt="${item.name}" style="max-width: 50px;"></td>
                                <td>${item.name}</td>
                                <td>${item.description || "Không có mô tả"}</td>
                                <td>${getSupplierName(item.supplier_id)}</td>
                                <td>${item.quantity}</td>
                                <td>${item.unitPrice.toLocaleString()}</td>
                                <td>${(item.quantity * item.unitPrice).toLocaleString()}</td>
                            </tr>
                        `;
                    });
                }

                // Cập nhật danh sách dịch vụ
                const staffList = document.getElementById("staffList");
                staffList.innerHTML = "";
                const services = event.service || [];
                if (services.length === 0) {
                    staffList.innerHTML = "<tr><td colspan='7'>Không có dịch vụ</td></tr>";
                } else {
                    services.forEach(item => {
                        staffList.innerHTML += `
                            <tr>
                                <td><img src="${item.image || './assets/img/placeholder.jpg'}" alt="${item.name}" style="max-width: 50px;"></td>
                                <td>${item.name}</td>
                                <td>${item.description || "Không có mô tả"}</td>
                                <td>${getSupplierName(item.supplier_id)}</td>
                                <td>${item.quantity}</td>
                                <td>${item.unitPrice.toLocaleString()}</td>
                                <td>${(item.quantity * item.unitPrice).toLocaleString()}</td>
                            </tr>
                        `;
                    });
                }

                // Cập nhật danh sách địa điểm
                const locationList = document.getElementById("locationList");
                locationList.innerHTML = "";
                const locations = event.location || event.locations || [];
                if (locations.length === 0) {
                    locationList.innerHTML = "<tr><td colspan='8'>Không có địa điểm</td></tr>";
                } else {
                    locations.forEach(item => {
                        // Tính số ngày thuê
                        const fromDate = new Date(item.fromDate);
                        const toDate = new Date(item.toDate);
                        const diffTime = Math.abs(toDate - fromDate);
                        const days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 để tính cả ngày đầu và cuối

                        // Định dạng ngày
                        const formattedFromDate = formatDateToDDMMYYYY(item.fromDate);
                        const formattedToDate = formatDateToDDMMYYYY(item.toDate);

                        locationList.innerHTML += `
                            <tr>
                                <td><img src="${item.image || './assets/img/placeholder.jpg'}" alt="${item.name}" style="max-width: 50px;"></td>
                                <td>${item.name}</td>
                                <td>${getSupplierName(item.supplier_id)}</td>
                                <td>${formattedFromDate}</td>
                                <td>${formattedToDate}</td>
                                <td>${days}</td>
                                <td>${item.unitPrice.toLocaleString()}</td>
                                <td>${(days * item.unitPrice).toLocaleString()}</td>
                            </tr>
                        `;
                    });
                }

                // Kiểm tra nếu cần mở modal sau khi đăng nhập
                if (localStorage.getItem("openContractAfterLogin") === "true") {
                    localStorage.removeItem("openContractAfterLogin");
                    openContractModal();
                }
            } catch (error) {
                console.error("Lỗi khi tải dữ liệu:", error);
                document.getElementById("eventName").textContent = "Lỗi tải dữ liệu!";
                document.getElementById("eventDescription").textContent = "Vui lòng thử lại sau.";
            } finally {
                preloader.style.display = "none";
            }
        });

        function checkLoginAndOpenContract() {
            console.log("Nút Đăng ký ngay được nhấn!");
            const token = localStorage.getItem("token");
            if (!token) {
                localStorage.setItem("openContractAfterLogin", "true");
                const urlParams = new URLSearchParams(window.location.search);
                const eventId = urlParams.get("id");
                localStorage.setItem("redirectAfterLogin", `event_detail.html?id=${eventId}`);
                window.location.href = "login.html";
            } else {
                openContractModal();
            }
        }

        function openContractModal() {
            console.log("Mở modal hợp đồng");
            const iframe = document.getElementById("contractIframe");
            if (!iframe) {
                console.error("Không tìm thấy iframe!");
                return;
            }
            iframe.src = "contract.html";

            const modalElement = document.getElementById("iframeModal");
            if (!modalElement) {
                console.error("Không tìm thấy modal!");
                return;
            }
            const modal = new bootstrap.Modal(modalElement, {});
            modal.show();

            iframe.onload = function () {
                console.log("Iframe loaded, gửi dữ liệu:", selectedEvent);
                if (selectedEvent) {
                    const eventData = {
                        type: "preloadEvent",
                        event: {
                            name: selectedEvent.name,
                            description: selectedEvent.description || "",
                            device: selectedEvent.device || [],
                            service: selectedEvent.service || [],
                            locations: selectedEvent.location || selectedEvent.locations || [],
                            timeline: selectedEvent.timeline || []
                        }
                    };
                    iframe.contentWindow.postMessage(eventData, "*");
                } else {
                    console.error("Không có dữ liệu sự kiện để gửi!");
                }
            };

            window.addEventListener("message", function closeModal(event) {
                if (event.data === "closeIframe") {
                    console.log("Nhận tín hiệu đóng modal");
                    modal.hide();
                    window.removeEventListener("message", closeModal);
                }
            }, { once: true });
        }
    </script>
</body>

</html>